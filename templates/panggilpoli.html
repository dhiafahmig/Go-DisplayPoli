<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panggil Pasien Poli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
        }
        .card {
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-panggil {
            background-color: #28a745;
            color: white;
        }
        .btn-ada, .btn-tidak, .btn-reset {
            margin-right: 5px;
        }
        .pasien-info {
            padding: 10px;
        }
        .pasien-ada {
            background-color: #d1e7dd;
        }
        .pasien-tidak {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h2>Panggil Pasien Poli</h2>
            <h4 id="jam"></h4>
        </div>
        
        <div class="row mb-3">
            <div class="col-12">
                <a href="/settings/poli" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Kembali ke Pengaturan
                </a>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="list-group">
                    {{range $index, $pasien := .PasienList}}
                    <div class="card {{if eq $pasien.status "0"}}pasien-ada{{else if eq $pasien.status "1"}}pasien-tidak{{end}}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">{{$pasien.nm_pasien}}</h5>
                                    <p class="card-text">
                                        <strong>No. Registrasi:</strong> {{$pasien.no_reg}}<br>
                                        <strong>No. Rawat:</strong> {{$pasien.no_rawat}}<br>
                                        <strong>Dokter:</strong> {{$pasien.nama_dokter}}<br>
                                        <strong>Poli:</strong> {{$pasien.nm_poli}}<br>
                                        <strong>Penjamin:</strong> {{$pasien.png_jawab}}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-panggil mb-2" onclick="panggilPasien('{{$pasien.nm_pasien}}', '{{$.KdRuangPoli}}', '{{$pasien.nm_poli}}', '{{$pasien.no_reg}}', '{{$.KdDisplay}}')">
                                        <i class="fas fa-volume-up"></i> Panggil
                                    </button>
                                    <br>
                                    <button class="btn btn-success btn-ada" onclick="handleLog('{{$pasien.kd_dokter}}', '{{$pasien.no_rawat}}', '{{$.KdRuangPoli}}', 'ada')">
                                        <i class="fas fa-check"></i> Ada
                                    </button>
                                    <button class="btn btn-danger btn-tidak" onclick="handleLog('{{$pasien.kd_dokter}}', '{{$pasien.no_rawat}}', '{{$.KdRuangPoli}}', 'tidak')">
                                        <i class="fas fa-times"></i> Tidak
                                    </button>
                                    <button class="btn btn-warning btn-reset" onclick="resetLog('{{$pasien.no_rawat}}')">
                                        <i class="fas fa-redo"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{else}}
                    <div class="card">
                        <div class="card-body text-center">
                            <p>Tidak ada pasien dalam antrian</p>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update jam
        function updateClock() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('jam').textContent = now.toLocaleDateString('id-ID', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Panggil pasien
        function panggilPasien(nmPasien, kdRuangPoli, nmPoli, noReg, kdDisplay) {
            fetch('/api/panggilpoli', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nm_pasien: nmPasien,
                    kd_ruang_poli: kdRuangPoli,
                    nm_poli: nmPoli,
                    no_reg: noReg,
                    kd_display: kdDisplay
                }),
            })
            .then(response => response.json())
            .then(data => {
                alert('Pasien dipanggil: ' + nmPasien);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memanggil pasien');
            });
        }

        // Handle log pasien (ada/tidak)
        function handleLog(kdDokter, noRawat, kdRuangPoli, type) {
            fetch('/api/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    kd_dokter: kdDokter,
                    no_rawat: noRawat,
                    kd_ruang_poli: kdRuangPoli,
                    type: type
                }),
            })
            .then(response => response.json())
            .then(data => {
                alert('Status pasien diupdate: ' + (type === 'ada' ? 'Hadir' : 'Tidak Hadir'));
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengupdate status pasien');
            });
        }

        // Reset log pasien
        function resetLog(noRawat) {
            fetch('/api/log/reset/' + noRawat, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                alert('Status pasien di-reset');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mereset status pasien');
            });
        }
    </script>
</body>
</html> 