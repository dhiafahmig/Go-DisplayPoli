<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Poli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <script src="https://kit.fontawesome.com/3b5b58c4f5.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink-animation {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .blink {
            animation: blink-animation 1.5s infinite;
        }
        
        .float {
            animation: float 6s ease-in-out infinite;
        }
        
        .gradient-header {
            background: #16a34a; /* Hijau solid */
        }
        
        .card-gradient {
            background-color: #f5f7fa; /* Warna solid light gray */
        }
        
        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(34, 197, 94, 0.2), 0 8px 10px -6px rgba(34, 197, 94, 0.2);
        }
        
        .highlight-shadow {
            box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4);
            transition: box-shadow 0.5s ease;
        }
        
        .clock-animation {
            transition: all 0.5s ease;
        }
        
        .clock-animation:hover {
            transform: scale(1.05);
        }
        
        /* Mencegah pengguna memilih teks */
        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Style untuk tombol fullscreen */
        .fullscreen-btn {
            position: fixed;
            bottom: 70px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(34, 197, 94, 0.7);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .fullscreen-btn:hover {
            background-color: rgba(22, 163, 74, 0.9);
            transform: scale(1.1);
        }
        
        /* Style untuk overlay untuk mencegah interaksi yang tidak diinginkan */
        .lock-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 9998;
            pointer-events: none;
        }
        
        .lock-message {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        
        /* Mode kiosk */
        .kiosk-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9000;
            background-color: #f1f5f9;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
    <div id="kioskContainer" class="kiosk-mode">
    <!-- Header -->
    <div class="gradient-header text-white shadow-lg py-6 sticky top-0 z-50">
        <div class="container mx-auto px-6">
            <div class="flex flex-col items-center justify-between md:flex-row">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="flex items-center mr-5">
                        <!-- Logo BW -->
                        <div class="bg-white p-3 rounded-lg shadow-md h-20 flex items-center mr-4">
                            <img src="/assets/images/rs.png" alt="Bumi Waras Logo" class="h-full">
                        </div>
                        <i class="fas fa-hospital-alt text-5xl mr-4 text-green-100"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-extrabold tracking-tight uppercase">ANTRIAN POLI</h1>
                        <p class="text-green-200 text-sm mt-1 font-semibold">Rumah Sakit Bumi Waras</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="clock-animation bg-green-700/30 px-5 py-2 rounded-full border border-green-400/30 backdrop-blur-sm mr-4">
                        <h3 id="jam" class="text-xl font-light"></h3>
                    </div>
                    <!-- Logo BPJS -->
                    <div class="bg-white p-2 rounded-lg shadow-md h-14 flex items-center">
                        <img src="/assets/images/bpjs.png" alt="BPJS Logo" class="h-full">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container mx-auto px-6 py-10">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-28">
            {{if eq (len .PoliList) 1}}
                <div class="md:col-span-2 flex justify-center">
                    {{range $index, $poli := .PoliList}}
                    <div id="poli-card-{{$poli.kd_ruang_poli}}" class="bg-white rounded-xl custom-shadow overflow-hidden transform hover:scale-[1.02] transition-all duration-300 w-full md:w-1/2">
                        <div class="gradient-header text-white py-5 px-6">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-stethoscope text-xl mr-3 text-green-200"></i>
                                <h2 class="text-2xl font-semibold">{{$poli.nama_ruang_poli}}</h2>
                            </div>
                        </div>
                        <div class="p-8 text-center card-gradient">
                            {{if $poli.getPasien}}
                                {{range $pasien := $poli.getPasien}}
                                <div class="mb-6">
                                    <div class="flex items-center justify-center mb-3">
                                        <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                                        <p class="text-gray-700 text-lg font-bold">Pasien:</p>
                                    </div>
                                    <div class="bg-white rounded-lg py-4 px-4 shadow-inner border border-green-100">
                                        <p class="text-gray-800 text-2xl font-bold">{{$pasien.nm_pasien}}</p>
                                    </div>
                                </div>
                                <div class="mt-8 float">
                                    <div class="flex items-center justify-center mb-3">
                                        <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                                        <p class="text-gray-700 text-lg font-bold">No. Antrian:</p>
                                    </div>
                                    <div class="bg-primary-50 rounded-lg py-5 shadow-inner border border-primary-200">
                                        <p class="text-primary-600 text-6xl font-extrabold blink">{{$pasien.no_reg}}</p>
                                    </div>
                                </div>
                                
                                <!-- Informasi Dokter -->
                                <div class="mt-6 bg-white/80 rounded-lg p-4 border border-green-100 shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-user-md text-primary-500 mr-2 text-xl"></i>
                                            <div class="text-left">
                                                <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                                <p class="text-gray-800 font-bold">{{$pasien.nama_dokter}}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="far fa-clock text-primary-500 mr-2 text-xl"></i>
                                            <div class="text-left">
                                                <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                                <p class="text-gray-800 font-bold">{{$pasien.jam_mulai}} WIB</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {{end}}
                            {{else}}
                                <div class="py-20 flex flex-col items-center">
                                    <i class="far fa-calendar-times text-6xl text-gray-300 mb-5 animate-pulse-slow"></i>
                                    <p class="text-2xl text-gray-500 font-bold">Tidak ada pasien</p>
                                    <p class="text-sm text-gray-400 mt-2 font-medium">Silakan menunggu antrian berikutnya</p>
                                </div>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            {{else}}
                {{range $index, $poli := .PoliList}}
                <div id="poli-card-{{$poli.kd_ruang_poli}}" class="bg-white rounded-xl custom-shadow overflow-hidden transform hover:scale-[1.02] transition-all duration-300">
                    <div class="gradient-header text-white py-5 px-6">
                        <div class="flex items-center justify-center">
                            <i class="fas fa-stethoscope text-xl mr-3 text-green-200"></i>
                            <h2 class="text-2xl font-semibold">{{$poli.nama_ruang_poli}}</h2>
                        </div>
                    </div>
                    <div class="p-8 text-center card-gradient">
                        {{if $poli.getPasien}}
                            {{range $pasien := $poli.getPasien}}
                            <div class="mb-6">
                                <div class="flex items-center justify-center mb-3">
                                    <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                                    <p class="text-gray-700 text-lg font-bold">Pasien:</p>
                                </div>
                                <div class="bg-white rounded-lg py-4 px-4 shadow-inner border border-green-100">
                                    <p class="text-gray-800 text-2xl font-bold">{{$pasien.nm_pasien}}</p>
                                </div>
                            </div>
                            <div class="mt-8 float">
                                <div class="flex items-center justify-center mb-3">
                                    <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                                    <p class="text-gray-700 text-lg font-bold">No. Antrian:</p>
                                </div>
                                <div class="bg-primary-50 rounded-lg py-5 shadow-inner border border-primary-200">
                                    <p class="text-primary-600 text-6xl font-extrabold blink">{{$pasien.no_reg}}</p>
                                </div>
                            </div>
                            
                            <!-- Informasi Dokter -->
                            <div class="mt-6 bg-white/80 rounded-lg p-4 border border-green-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-user-md text-primary-500 mr-2 text-xl"></i>
                                        <div class="text-left">
                                            <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                            <p class="text-gray-800 font-bold">{{$pasien.nama_dokter}}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="far fa-clock text-primary-500 mr-2 text-xl"></i>
                                        <div class="text-left">
                                            <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                            <p class="text-gray-800 font-bold">{{$pasien.jam_mulai}} WIB</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{end}}
                        {{else}}
                            <div class="py-20 flex flex-col items-center">
                                <i class="far fa-calendar-times text-6xl text-gray-300 mb-5 animate-pulse-slow"></i>
                                <p class="text-2xl text-gray-500 font-bold">Tidak ada pasien</p>
                                <p class="text-sm text-gray-400 mt-2 font-medium">Silakan menunggu antrian berikutnya</p>
                            </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            {{end}}
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white py-6 text-center text-gray-600 fixed bottom-0 w-full shadow-md border-t border-gray-100">
        <div class="container mx-auto">
            <div class="flex items-center justify-center">
                <i class="far fa-copyright mr-2"></i>
                <p>2025 Display Poli Rumah Sakit Bumi Waras</p>
            </div>
            <p class="text-xs text-gray-400 mt-1">Dhia Fahmi G</p>
        </div>
    </footer>

    <!-- Tombol Fullscreen dan Kunci Layar -->
    <div id="fullscreenBtn" class="fullscreen-btn" title="Mode Layar Penuh">
        <i class="fas fa-expand"></i>
    </div>
    
    <div id="lockOverlay" class="lock-overlay"></div>
    <div id="lockMessage" class="lock-message">Display Terkunci (Alt+L untuk membuka)</div>

    <!-- Notification Sound -->
    <audio id="notificationSound" src="/assets/notification.mp3" preload="auto"></audio>
    </div>

    <script>
        // Update jam
        function updateClock() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('jam').textContent = now.toLocaleDateString('id-ID', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Setup WebSocket
        const socket = new WebSocket('ws://{{.AppURL}}/ws/{{.KdDisplay}}');
        
        socket.onopen = function(e) {
            console.log('WebSocket connection established');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.kd_display === '{{.KdDisplay}}') {
                handlePanggilan(data);
            }
        };
        
        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log('WebSocket connection closed cleanly');
            } else {
                console.error('WebSocket connection died');
            }
            
            // Coba hubungkan kembali tanpa reload halaman penuh
            setTimeout(function() {
                reconnectWebSocket();
            }, 5000);
        };
        
        socket.onerror = function(error) {
            console.error('WebSocket Error:', error);
        };

        // Fungsi untuk reconnect WebSocket tanpa reload halaman
        function reconnectWebSocket() {
            console.log("Mencoba menghubungkan kembali WebSocket...");
            
            // Buat koneksi WebSocket baru
            socket = new WebSocket('ws://{{.AppURL}}/ws/{{.KdDisplay}}');
            
            // Reinisialisasi event handlers
            socket.onopen = function(e) {
                console.log('WebSocket connection re-established');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.kd_display === '{{.KdDisplay}}') {
                    handlePanggilan(data);
                }
            };
            
            socket.onclose = function(event) {
                if (event.wasClean) {
                    console.log('WebSocket connection closed cleanly');
                } else {
                    console.error('WebSocket connection died');
                }
                
                // Coba lagi setelah delay
                setTimeout(function() {
                    reconnectWebSocket();
                }, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket Error:', error);
            };
        }

        // Handle panggilan pasien
        function handlePanggilan(data) {
            const poliCard = document.getElementById('poli-card-' + data.kd_ruang_poli);
            if (poliCard) {
                // Perbarui header poli
                const poliHeader = poliCard.querySelector('.gradient-header');
                poliHeader.innerHTML = `
                    <div class="flex items-center justify-center">
                        <i class="fas fa-stethoscope text-xl mr-3 text-green-200"></i>
                        <h2 class="text-2xl font-extrabold">${data.nm_poli || data.nama_ruang_poli}</h2>
                    </div>
                `;

                // Perbarui body kartu
                const cardBody = poliCard.querySelector('div:nth-child(2)');
                cardBody.innerHTML = `
                    <div class="mb-6">
                        <div class="flex items-center justify-center mb-3">
                            <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                            <p class="text-gray-700 text-lg font-bold">Pasien:</p>
                        </div>
                        <div class="bg-white rounded-lg py-4 px-4 shadow-inner border border-green-100">
                            <p class="text-gray-800 text-2xl font-bold">${data.nm_pasien}</p>
                        </div>
                    </div>
                    <div class="mt-8 float">
                        <div class="flex items-center justify-center mb-3">
                            <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                            <p class="text-gray-700 text-lg font-bold">No. Antrian:</p>
                        </div>
                        <div class="bg-primary-50 rounded-lg py-5 shadow-inner border border-primary-200">
                            <p class="text-primary-600 text-6xl font-extrabold blink">${data.no_reg}</p>
                        </div>
                    </div>
                    
                    <!-- Informasi Dokter -->
                    <div class="mt-6 bg-white/80 rounded-lg p-4 border border-green-100 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-user-md text-primary-500 mr-2 text-xl"></i>
                                <div class="text-left">
                                    <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                    <p class="text-gray-800 font-bold">${data.nama_dokter || '-'}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="far fa-clock text-primary-500 mr-2 text-xl"></i>
                                <div class="text-left">
                                    <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                    <p class="text-gray-800 font-bold">${data.jam_mulai || '-'} WIB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Play notification sound
                const audio = document.getElementById('notificationSound');
                if (audio) {
                    audio.play().catch(error => {
                        console.error('Notification sound error:', error);
                    });
                }
                
                // Highlight the card with animation
                poliCard.classList.add('highlight-shadow');
                setTimeout(() => {
                    poliCard.classList.remove('highlight-shadow');
                }, 5000);
            }
        }

        // Handle window resize for better responsive behavior
        function handleResize() {
            const height = window.innerHeight;
            const cards = document.querySelectorAll('.card-gradient');
            
            cards.forEach(card => {
                const availableHeight = height - 300; // Account for header and footer
                const minHeight = Math.min(400, availableHeight);
                card.style.minHeight = `${minHeight}px`;
            });
        }

        window.addEventListener('resize', handleResize);
        handleResize(); // Call once on page load
        
        // Fullscreen management
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const lockOverlay = document.getElementById('lockOverlay');
        const lockMessage = document.getElementById('lockMessage');
        let isLocked = false;
        
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        
        // Alt+L untuk toggle lock screen
        document.addEventListener('keydown', function(e) {
            if (e.altKey && e.key === 'l') {
                toggleScreenLock();
            }
        });
        
        function toggleScreenLock() {
            isLocked = !isLocked;
            
            if (isLocked) {
                lockOverlay.style.display = 'block';
                lockMessage.style.display = 'block';
                // Mencegah mouse events saat terkunci
                lockOverlay.style.pointerEvents = 'auto';
                // Tampilkan pesan selama 3 detik
                setTimeout(() => {
                    lockMessage.style.display = 'none';
                }, 3000);
            } else {
                lockOverlay.style.display = 'none';
                lockMessage.style.display = 'none';
                lockOverlay.style.pointerEvents = 'none';
            }
        }
        
        // Auto fullscreen saat halaman dimuat
        window.addEventListener('load', function() {
            setTimeout(function() {
                enterFullScreen();
                // Auto-lock setelah masuk fullscreen
                setTimeout(() => {
                    toggleScreenLock();
                }, 500);
            }, 1000);
        });
        
        function toggleFullScreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                enterFullScreen();
            } else {
                exitFullScreen();
            }
            
            updateFullscreenButton();
        }
        
        function enterFullScreen() {
            try {
                const elem = document.getElementById('kioskContainer');
                
                if (elem.requestFullscreen) {
                    elem.requestFullscreen({ navigationUI: "hide" });
                } else if (elem.mozRequestFullScreen) { // Firefox
                    elem.mozRequestFullScreen({ navigationUI: "hide" });
                } else if (elem.webkitRequestFullscreen) { // Chrome, Safari, Opera
                    elem.webkitRequestFullscreen({ navigationUI: "hide" });
                } else if (elem.msRequestFullscreen) { // IE/Edge
                    elem.msRequestFullscreen({ navigationUI: "hide" });
                }
            } catch (err) {
                console.error("Fullscreen error:", err);
            }
        }
        
        function exitFullScreen() {
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            } catch (err) {
                console.error("Exit fullscreen error:", err);
            }
        }
        
        function updateFullscreenButton() {
            if (document.fullscreenElement || 
                document.mozFullScreenElement || 
                document.webkitFullscreenElement || 
                document.msFullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = "Keluar dari Mode Layar Penuh";
            } else {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = "Mode Layar Penuh";
            }
        }
        
        // Mendeteksi perubahan mode fullscreen
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);
        
        // Jangan mencoba ulang fullscreen secara agresif
        // karena ini bisa menyebabkan browser menolak permintaan
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                console.log("Keluar dari mode fullscreen");
            }
        });
        
        // Reset posisi scroll ke atas saat refresh
        window.addEventListener('beforeunload', function() {
            window.scrollTo(0, 0);
        });
    </script>
</body>
</html> 