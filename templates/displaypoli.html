<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Poli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <script src="https://kit.fontawesome.com/3b5b58c4f5.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink-animation {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .blink {
            animation: blink-animation 1.5s infinite;
        }
        
        .float {
            animation: float 6s ease-in-out infinite;
        }
        
        .gradient-header {
            background: #16a34a; /* Hijau solid */
        }
        
        .card-gradient {
            background-color: #f5f7fa; /* Warna solid light gray */
        }
        
        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(34, 197, 94, 0.2), 0 8px 10px -6px rgba(34, 197, 94, 0.2);
        }
        
        .highlight-shadow {
            box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4);
            transition: box-shadow 0.5s ease;
        }
        
        .clock-animation {
            transition: all 0.5s ease;
        }
        
        .clock-animation:hover {
            transform: scale(1.05);
        }
        
        /* Mencegah pengguna memilih teks */
        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            overflow-y: auto;
        }
        
        /* Untuk kasus 3 poli tanpa scroll */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }
        
        /* Mencegah overflow pada kartu */
        .truncate-content {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Optimasi untuk kasus 3 poli */
        .compact-card {
            display: flex;
            flex-direction: column;
        }
        
        .compact-card > div {
            margin-bottom: 0.5rem;
        }
        
        /* Layout khusus untuk tiga poli */
        .three-poli-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 1rem;
            margin-bottom: 4rem;
        }
        
        .three-poli-grid > div:last-child {
            grid-column: 1 / span 2;
            justify-self: center;
            width: 70%;
        }
        
        @media (max-width: 768px) {
            .three-poli-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .three-poli-grid > div:last-child {
                grid-column: 1;
                width: 100%;
            }
        }
        
        /* Ukuran optimal untuk poli */
        .poli-small {
            font-size: 90%;
        }
        
        .poli-small .gradient-header h2 {
            font-size: 1.5rem;
        }
        
        .poli-small .text-5xl {
            font-size: 2.5rem;
        }
        
        /* Optimasi header dan footer untuk 3 poli */
        .slim-header {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .slim-footer {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        /* Style untuk tombol fullscreen */
        .fullscreen-btn {
            position: fixed;
            bottom: 70px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(34, 197, 94, 0.7);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .fullscreen-btn:hover {
            background-color: rgba(22, 163, 74, 0.9);
            transform: scale(1.1);
        }
        
        /* Style untuk overlay untuk mencegah interaksi yang tidak diinginkan */
        .lock-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 9998;
            pointer-events: none;
        }
        
        .lock-message {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        
        /* Mode kiosk */
        .kiosk-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9000;
            background-color: #f1f5f9;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
    <div id="kioskContainer" class="kiosk-mode">
    <!-- Header -->
    <div class="gradient-header text-white shadow-lg py-4 sticky top-0 z-50">
        <div class="container mx-auto px-6">
            <div class="flex flex-col items-center justify-between md:flex-row">
                <div class="flex items-center mb-3 md:mb-0">
                    <div class="flex items-center mr-4">
                        <!-- Logo BW -->
                        <div class="bg-white p-2 rounded-lg shadow-md h-14 flex items-center mr-3">
                            <img src="/assets/images/rs.png" alt="Bumi Waras Logo" class="h-full">
                        </div>
                        <i class="fas fa-hospital-alt text-4xl mr-3 text-green-100"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight uppercase">ANTRIAN POLI</h1>
                        <p class="text-green-200 text-sm mt-1 font-semibold">Rumah Sakit Bumi Waras</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="text-right md:ml-8 text-lg font-medium clock-animation">
                        <i class="far fa-clock text-green-100 mr-2"></i>
                        <span id="jam">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Layout khusus untuk 3 poli, jika ada 3 poli -->
        {{if eq (len .PoliList) 3}}
        <div class="three-poli-grid">
            {{range $index, $poli := .PoliList}}
            <div id="poli-card-{{$poli.kd_ruang_poli}}" class="bg-white rounded-xl custom-shadow overflow-hidden transform hover:scale-[1.02] transition-all duration-300 poli-small">
                <div class="gradient-header text-white py-3 px-4">
                    <div class="flex items-center justify-center">
                        <i class="fas fa-stethoscope text-xl mr-2 text-green-200"></i>
                        <h2 class="text-xl font-semibold">{{$poli.nama_ruang_poli}}</h2>
                    </div>
                </div>
                <div class="p-3 text-center card-gradient">
                    {{if $poli.getPasien}}
                        {{range $pasien := $poli.getPasien}}
                        <div class="mb-2">
                            <div class="flex items-center justify-center mb-1">
                                <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                                <p class="text-gray-700 text-base font-bold">Pasien:</p>
                            </div>
                            <div class="bg-white rounded-lg py-2 px-3 shadow-inner border border-green-100">
                                <p class="text-gray-800 text-xl font-bold truncate-content">{{$pasien.nm_pasien}}</p>
                            </div>
                        </div>
                        <div class="mt-2 float">
                            <div class="flex items-center justify-center mb-1">
                                <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                                <p class="text-gray-700 text-base font-bold">No. Antrian:</p>
                            </div>
                            <div class="bg-primary-50 rounded-lg py-2 shadow-inner border border-primary-200">
                                <p class="text-primary-600 text-4xl font-extrabold blink">{{$pasien.no_reg}}</p>
                            </div>
                        </div>
                        
                        <!-- Informasi Dokter -->
                        <div class="mt-2 bg-white/80 rounded-lg p-2 border border-green-100 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-user-md text-primary-500 mr-1 text-lg"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                        <p class="text-gray-800 text-sm font-bold truncate-content">{{$pasien.nama_dokter}}</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="far fa-clock text-primary-500 mr-1 text-lg"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                        <p class="text-gray-800 text-sm font-bold">{{$pasien.jam_mulai}} WIB</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="py-8 flex flex-col items-center">
                            <i class="far fa-calendar-times text-4xl text-gray-300 mb-2 animate-pulse-slow"></i>
                            <p class="text-lg text-gray-500 font-bold">Tidak ada pasien</p>
                            <p class="text-xs text-gray-400 mt-1 font-medium">Silakan menunggu antrian berikutnya</p>
                        </div>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{else if eq (len .PoliList) 1}}
        <!-- Layout untuk 1 poli saja (di tengah) -->
        <div class="flex justify-center mb-16">
            {{range $index, $poli := .PoliList}}
            <div id="poli-card-{{$poli.kd_ruang_poli}}" class="bg-white rounded-xl custom-shadow overflow-hidden transform hover:scale-[1.02] transition-all duration-300 w-full md:w-1/2">
                <div class="gradient-header text-white py-5 px-6">
                    <div class="flex items-center justify-center">
                        <i class="fas fa-stethoscope text-xl mr-3 text-green-200"></i>
                        <h2 class="text-2xl font-semibold">{{$poli.nama_ruang_poli}}</h2>
                    </div>
                </div>
                <div class="p-6 text-center card-gradient">
                    {{if $poli.getPasien}}
                        {{range $pasien := $poli.getPasien}}
                        <div class="mb-5">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                                <p class="text-gray-700 text-lg font-bold">Pasien:</p>
                            </div>
                            <div class="bg-white rounded-lg py-3 px-4 shadow-inner border border-green-100">
                                <p class="text-gray-800 text-2xl font-bold">{{$pasien.nm_pasien}}</p>
                            </div>
                        </div>
                        <div class="mt-6 float">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                                <p class="text-gray-700 text-lg font-bold">No. Antrian:</p>
                            </div>
                            <div class="bg-primary-50 rounded-lg py-4 shadow-inner border border-primary-200">
                                <p class="text-primary-600 text-6xl font-extrabold blink">{{$pasien.no_reg}}</p>
                            </div>
                        </div>
                        
                        <!-- Informasi Dokter -->
                        <div class="mt-5 bg-white/80 rounded-lg p-3 border border-green-100 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-user-md text-primary-500 mr-2 text-xl"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                        <p class="text-gray-800 font-bold">{{$pasien.nama_dokter}}</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="far fa-clock text-primary-500 mr-2 text-xl"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                        <p class="text-gray-800 font-bold">{{$pasien.jam_mulai}} WIB</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="py-16 flex flex-col items-center">
                            <i class="far fa-calendar-times text-6xl text-gray-300 mb-5 animate-pulse-slow"></i>
                            <p class="text-2xl text-gray-500 font-bold">Tidak ada pasien</p>
                            <p class="text-sm text-gray-400 mt-2 font-medium">Silakan menunggu antrian berikutnya</p>
                        </div>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{else if eq (len .PoliList) 2}}
        <!-- Layout untuk 2 poli saja (grid yang lebih ramping) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-28 max-w-7xl mx-auto">
            {{range $index, $poli := .PoliList}}
            <div id="poli-card-{{$poli.kd_ruang_poli}}" class="bg-white rounded-xl custom-shadow overflow-hidden transform hover:scale-[1.02] transition-all duration-300">
                <div class="gradient-header text-white py-6 px-8">
                    <div class="flex items-center justify-center">
                        <i class="fas fa-stethoscope text-2xl mr-3 text-green-200"></i>
                        <h2 class="text-3xl font-semibold">{{$poli.nama_ruang_poli}}</h2>
                    </div>
                </div>
                <div class="p-8 text-center card-gradient">
                    {{if $poli.getPasien}}
                        {{range $pasien := $poli.getPasien}}
                        <div class="mb-6">
                            <div class="flex items-center justify-center mb-3">
                                <i class="fas fa-user-alt text-primary-500 mr-2 text-xl"></i>
                                <p class="text-gray-700 text-xl font-bold">Pasien:</p>
                            </div>
                            <div class="bg-white rounded-lg py-5 px-6 shadow-inner border border-green-100">
                                <p class="text-gray-800 text-3xl font-bold">{{$pasien.nm_pasien}}</p>
                            </div>
                        </div>
                        <div class="mt-8 float">
                            <div class="flex items-center justify-center mb-3">
                                <i class="fas fa-ticket-alt text-primary-500 mr-2 text-xl"></i>
                                <p class="text-gray-700 text-xl font-bold">No. Antrian:</p>
                            </div>
                            <div class="bg-primary-50 rounded-lg py-6 shadow-inner border border-primary-200">
                                <p class="text-primary-600 text-7xl font-extrabold blink">{{$pasien.no_reg}}</p>
                            </div>
                        </div>
                        
                        <!-- Informasi Dokter -->
                        <div class="mt-8 bg-white/80 rounded-lg p-5 border border-green-100 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-user-md text-primary-500 mr-2 text-2xl"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-sm font-semibold">Dokter</p>
                                        <p class="text-gray-800 text-lg font-bold">{{$pasien.nama_dokter}}</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="far fa-clock text-primary-500 mr-2 text-2xl"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-sm font-semibold">Jam Praktek</p>
                                        <p class="text-gray-800 text-lg font-bold">{{$pasien.jam_mulai}} WIB</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="py-20 flex flex-col items-center">
                            <i class="far fa-calendar-times text-7xl text-gray-300 mb-6 animate-pulse-slow"></i>
                            <p class="text-3xl text-gray-500 font-bold">Tidak ada pasien</p>
                            <p class="text-base text-gray-400 mt-3 font-medium">Silakan menunggu antrian berikutnya</p>
                        </div>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <!-- Layout default untuk 4+ poli -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-28">
            {{range $index, $poli := .PoliList}}
            <div id="poli-card-{{$poli.kd_ruang_poli}}" class="bg-white rounded-xl custom-shadow overflow-hidden transform hover:scale-[1.02] transition-all duration-300">
                <div class="gradient-header text-white py-4 px-5">
                    <div class="flex items-center justify-center">
                        <i class="fas fa-stethoscope text-xl mr-3 text-green-200"></i>
                        <h2 class="text-2xl font-semibold">{{$poli.nama_ruang_poli}}</h2>
                    </div>
                </div>
                <div class="p-4 text-center card-gradient">
                    {{if $poli.getPasien}}
                        {{range $pasien := $poli.getPasien}}
                        <div class="mb-4">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                                <p class="text-gray-700 text-lg font-bold">Pasien:</p>
                            </div>
                            <div class="bg-white rounded-lg py-3 px-4 shadow-inner border border-green-100">
                                <p class="text-gray-800 text-2xl font-bold">{{$pasien.nm_pasien}}</p>
                            </div>
                        </div>
                        <div class="mt-4 float">
                            <div class="flex items-center justify-center mb-2">
                                <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                                <p class="text-gray-700 text-lg font-bold">No. Antrian:</p>
                            </div>
                            <div class="bg-primary-50 rounded-lg py-3 shadow-inner border border-primary-200">
                                <p class="text-primary-600 text-5xl font-extrabold blink">{{$pasien.no_reg}}</p>
                            </div>
                        </div>
                        
                        <!-- Informasi Dokter -->
                        <div class="mt-4 bg-white/80 rounded-lg p-3 border border-green-100 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-user-md text-primary-500 mr-2 text-xl"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                        <p class="text-gray-800 font-bold">{{$pasien.nama_dokter}}</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="far fa-clock text-primary-500 mr-2 text-xl"></i>
                                    <div class="text-left">
                                        <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                        <p class="text-gray-800 font-bold">{{$pasien.jam_mulai}} WIB</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="py-12 flex flex-col items-center">
                            <i class="far fa-calendar-times text-5xl text-gray-300 mb-4 animate-pulse-slow"></i>
                            <p class="text-xl text-gray-500 font-bold">Tidak ada pasien</p>
                            <p class="text-sm text-gray-400 mt-2 font-medium">Silakan menunggu antrian berikutnya</p>
                        </div>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{end}}
    </div>

    <!-- Footer -->
    <footer class="bg-white py-2 text-center text-gray-600 fixed bottom-0 w-full shadow-md border-t border-gray-100">
        <div class="container mx-auto">
            <div class="flex items-center justify-center text-sm">
                <i class="far fa-copyright mr-1"></i>
                <p>2025 Rumah Sakit Bumi Waras</p>
            </div>
        </div>
    </footer>

    <!-- Tombol Fullscreen dan Kunci Layar -->
    <div id="fullscreenBtn" class="fullscreen-btn" title="Mode Layar Penuh">
        <i class="fas fa-expand"></i>
    </div>
    
    <div id="lockOverlay" class="lock-overlay"></div>
    <div id="lockMessage" class="lock-message">Display Terkunci (Alt+L untuk membuka)</div>

    <!-- Notification Sound -->
    <audio id="notificationSound" src="/assets/notification.mp3" preload="auto"></audio>
    </div>

    <script>
        // Update jam
        function updateClock() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('jam').textContent = now.toLocaleDateString('id-ID', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Setup WebSocket
        const socket = new WebSocket('ws://{{.AppURL}}/ws/{{.KdDisplay}}');
        
        socket.onopen = function(e) {
            console.log('WebSocket connection established');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.kd_display === '{{.KdDisplay}}') {
                handlePanggilan(data);
            }
        };
        
        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log('WebSocket connection closed cleanly');
            } else {
                console.error('WebSocket connection died');
            }
            
            // Coba hubungkan kembali tanpa reload halaman penuh
            setTimeout(function() {
                reconnectWebSocket();
            }, 5000);
        };
        
        socket.onerror = function(error) {
            console.error('WebSocket Error:', error);
        };

        // Fungsi untuk reconnect WebSocket tanpa reload halaman
        function reconnectWebSocket() {
            console.log("Mencoba menghubungkan kembali WebSocket...");
            
            // Buat koneksi WebSocket baru
            socket = new WebSocket('ws://{{.AppURL}}/ws/{{.KdDisplay}}');
            
            // Reinisialisasi event handlers
            socket.onopen = function(e) {
                console.log('WebSocket connection re-established');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.kd_display === '{{.KdDisplay}}') {
                    handlePanggilan(data);
                }
            };
            
            socket.onclose = function(event) {
                if (event.wasClean) {
                    console.log('WebSocket connection closed cleanly');
                } else {
                    console.error('WebSocket connection died');
                }
                
                // Coba lagi setelah delay
                setTimeout(function() {
                    reconnectWebSocket();
                }, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket Error:', error);
            };
        }

        // Handle panggilan pasien
        function handlePanggilan(data) {
            const poliCard = document.getElementById('poli-card-' + data.kd_ruang_poli);
            if (poliCard) {
                // Perbarui header poli
                const poliHeader = poliCard.querySelector('.gradient-header');
                
                // Deteksi apakah ada 3 poli untuk styling yang optimal
                const poliCount = document.querySelectorAll('.card-gradient').length;
                
                if (poliCount === 3) {
                    // Gunakan ukuran yang lebih kecil untuk 3 poli
                    poliHeader.innerHTML = `
                        <div class="flex items-center justify-center">
                            <i class="fas fa-stethoscope text-lg mr-2 text-green-200"></i>
                            <h2 class="text-lg font-semibold">${data.nm_poli || data.nama_ruang_poli}</h2>
                        </div>
                    `;
                } else {
                    // Ukuran normal untuk 1, 2 atau 4+ poli
                    poliHeader.innerHTML = `
                        <div class="flex items-center justify-center">
                            <i class="fas fa-stethoscope text-xl mr-3 text-green-200"></i>
                            <h2 class="text-2xl font-extrabold">${data.nm_poli || data.nama_ruang_poli}</h2>
                        </div>
                    `;
                }

                // Perbarui body kartu
                const cardBody = poliCard.querySelector('div:nth-child(2)');
                
                // Tentukan kelas dan ukuran berdasarkan jumlah poli
                const compactClass = poliCount === 3 ? 'compact-card' : '';
                const nameClass = poliCount === 3 ? 'truncate-content text-lg' : 'text-2xl';
                const regSize = poliCount === 3 ? 'text-4xl' : 'text-5xl';
                const padding = poliCount === 3 ? 'p-2' : 'p-4';
                const margin = poliCount === 3 ? 'mb-2 mt-2' : 'mb-4 mt-4';
                const iconSize = poliCount === 3 ? 'text-lg' : 'text-xl';
                
                cardBody.className = `${padding} text-center card-gradient`;
                cardBody.innerHTML = `
                    <div class="${margin} ${compactClass}">
                        <div class="flex items-center justify-center mb-1">
                            <i class="fas fa-user-alt text-primary-500 mr-2"></i>
                            <p class="text-gray-700 text-base font-bold">Pasien:</p>
                        </div>
                        <div class="bg-white rounded-lg py-2 px-3 shadow-inner border border-green-100">
                            <p class="text-gray-800 ${nameClass} font-bold truncate-content">${data.nm_pasien}</p>
                        </div>
                    </div>
                    <div class="${margin} float">
                        <div class="flex items-center justify-center mb-1">
                            <i class="fas fa-ticket-alt text-primary-500 mr-2"></i>
                            <p class="text-gray-700 text-base font-bold">No. Antrian:</p>
                        </div>
                        <div class="bg-primary-50 rounded-lg py-2 shadow-inner border border-primary-200">
                            <p class="text-primary-600 ${regSize} font-extrabold blink">${data.no_reg}</p>
                        </div>
                    </div>
                    
                    <!-- Informasi Dokter -->
                    <div class="${margin} bg-white/80 rounded-lg p-2 border border-green-100 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-user-md text-primary-500 mr-1 ${iconSize}"></i>
                                <div class="text-left">
                                    <p class="text-gray-500 text-xs font-semibold">Dokter</p>
                                    <p class="text-gray-800 text-sm font-bold truncate-content">${data.nama_dokter || '-'}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="far fa-clock text-primary-500 mr-1 ${iconSize}"></i>
                                <div class="text-left">
                                    <p class="text-gray-500 text-xs font-semibold">Jam Praktek</p>
                                    <p class="text-gray-800 text-sm font-bold">${data.jam_mulai || '-'} WIB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Play notification sound
                const audio = document.getElementById('notificationSound');
                if (audio) {
                    audio.play().catch(error => {
                        console.error('Notification sound error:', error);
                    });
                }
                
                // Highlight the card with animation
                poliCard.classList.add('highlight-shadow');
                setTimeout(() => {
                    poliCard.classList.remove('highlight-shadow');
                }, 5000);
                
                // Memanggil handleResize untuk menyesuaikan ukuran
                setTimeout(handleResize, 100);
            }
        }

        // Handle window resize for better responsive behavior
        function handleResize() {
            const height = window.innerHeight;
            const width = window.innerWidth;
            const headerHeight = document.querySelector('.gradient-header').offsetHeight;
            const footerHeight = document.querySelector('footer').offsetHeight;
            const cards = document.querySelectorAll('.card-gradient');
            
            // Menghitung ketinggian tersedia
            const availableHeight = height - headerHeight - footerHeight - 30; // 30px untuk margin dan padding
            
            // Cek jumlah poli
            const poliCount = cards.length;
            console.log(`Resize: ${poliCount} poli, height: ${height}px, available: ${availableHeight}px`);
            
            // Khusus untuk 3 poli, pastikan muat tanpa scroll
            if (poliCount === 3) {
                // Ubah layout container jika belum diubah
                const container = document.querySelector('.container.mx-auto.px-4.py-8');
                if (container) {
                    // Ubah padding container
                    container.classList.remove('py-8');
                    container.classList.add('py-4');
                }
                
                // Ubah header dan footer menjadi slim
                const header = document.querySelector('.gradient-header.sticky');
                if (header && !header.classList.contains('slim-header')) {
                    header.classList.add('slim-header');
                }
                
                const footer = document.querySelector('footer');
                if (footer && !footer.classList.contains('slim-footer')) {
                    footer.classList.add('slim-footer');
                }
                
                // Sesuaikan ukuran tinggi card
                if (width >= 768) { // desktop
                    const topCards = Array.from(cards).slice(0, 2);
                    const bottomCard = cards[2];
                    
                    // Tentukan ketinggian maksimum untuk mencegah scroll
                    // Kartu atas sekitar 45% dari tersedia, bawah sekitar 35%
                    const topCardHeight = Math.floor(availableHeight * 0.45);
                    const bottomCardHeight = Math.floor(availableHeight * 0.35);
                    
                    console.log(`3 poli: top cards ${topCardHeight}px, bottom card ${bottomCardHeight}px`);
                    
                    topCards.forEach(card => {
                        card.style.height = `${topCardHeight}px`;
                        card.style.maxHeight = `${topCardHeight}px`;
                        card.style.overflow = 'hidden';
                    });
                    
                    if (bottomCard) {
                        bottomCard.style.height = `${bottomCardHeight}px`;
                        bottomCard.style.maxHeight = `${bottomCardHeight}px`;
                        bottomCard.style.overflow = 'hidden';
                    }
                } else {
                    // Untuk mobile, masing-masing card lebih kecil
                    const cardHeight = Math.floor(availableHeight / 3.5); // Sedikit ruang ekstra
                    cards.forEach(card => {
                        card.style.height = `${cardHeight}px`;
                        card.style.maxHeight = `${cardHeight}px`;
                        card.style.overflow = 'hidden';
                    });
                }
                
                // Sesuaikan ukuran font dan padding untuk elemen dalam card
                document.querySelectorAll('.poli-small').forEach(card => {
                    // Kurangi padding
                    const contentDivs = card.querySelectorAll('.p-4, .py-3, .px-4, .py-2, .px-3');
                    contentDivs.forEach(div => {
                        div.classList.remove('p-4', 'py-3', 'px-4');
                        div.classList.add('p-2');
                    });
                    
                    // Kurangi margin
                    const marginElements = card.querySelectorAll('.mb-4, .mt-4');
                    marginElements.forEach(el => {
                        el.classList.remove('mb-4', 'mt-4');
                        el.classList.add('mb-2', 'mt-2');
                    });
                    
                    // Sesuaikan ukuran font nomor antrian
                    const regNumber = card.querySelector('.text-primary-600.blink');
                    if (regNumber) {
                        regNumber.classList.remove('text-6xl', 'text-5xl');
                        regNumber.classList.add('text-4xl');
                    }
                });
                
                // Force ukuran body untuk mencegah scroll
                document.body.classList.add('no-scroll');
            } else if (poliCount === 1) {
                // Satu poli saja - di tengah layar
                resetHeaderFooter();
                
                // Untuk 1 poli, kita tidak perlu terlalu banyak styling karena sudah diatur di HTML
                const onlyCard = cards[0];
                if (onlyCard) {
                    // Ukuran minimal, tapi tidak terlalu besar
                    const minHeight = Math.min(500, availableHeight * 0.8);
                    onlyCard.style.minHeight = `${minHeight}px`;
                    
                    // Pastikan konten tidak terpotong tapi juga tidak terlalu besar
                    onlyCard.style.overflow = 'auto';
                    
                    // Sesuaikan ukuran font nomor antrian untuk 1 poli
                    const regNumber = onlyCard.querySelector('.text-primary-600.blink');
                    if (regNumber) {
                        regNumber.classList.remove('text-4xl', 'text-5xl');
                        regNumber.classList.add('text-6xl');
                    }
                }
                
                // Memastikan scroll berfungsi jika konten terlalu panjang
                document.body.classList.remove('no-scroll');
            } else if (poliCount === 2) {
                // Dua poli - layout ramping dengan max-width
                resetHeaderFooter();
                
                // Untuk 2 poli, kita berikan ukuran yang lebih besar
                cards.forEach(card => {
                    const minHeight = Math.min(650, availableHeight * 0.9);
                    card.style.minHeight = `${minHeight}px`;
                    card.style.overflow = 'auto';
                    
                    // Sesuaikan ukuran font nomor antrian untuk 2 poli
                    const regNumber = card.querySelector('.text-primary-600.blink');
                    if (regNumber) {
                        regNumber.classList.remove('text-4xl', 'text-5xl', 'text-6xl');
                        regNumber.classList.add('text-7xl');
                    }
                    
                    // Tambahkan spasi horizontal lebih banyak
                    card.style.width = '100%';
                });
                
                document.body.classList.remove('no-scroll');
            } else {
                // Layout default untuk 4+ poli
                resetHeaderFooter();
                
                const minHeight = Math.min(350, availableHeight / Math.ceil(poliCount / 2));
                cards.forEach(card => {
                    card.style.minHeight = `${minHeight}px`;
                    card.classList.remove('poli-small');
                });
                document.body.classList.remove('no-scroll');
                
                // Sesuaikan ukuran font nomor antrian berdasarkan lebar kartu
                const regNumbers = document.querySelectorAll('.text-primary-600.blink');
                regNumbers.forEach(num => {
                    const cardWidth = num.closest('.card-gradient').offsetWidth;
                    if (cardWidth < 300) {
                        num.classList.remove('text-6xl', 'text-5xl');
                        num.classList.add('text-4xl');
                    } else if (cardWidth < 400) {
                        num.classList.remove('text-6xl', 'text-4xl');
                        num.classList.add('text-5xl');
                    } else {
                        num.classList.remove('text-5xl', 'text-4xl');
                        num.classList.add('text-6xl');
                    }
                });
            }
        }
        
        function resetHeaderFooter() {
            const header = document.querySelector('.gradient-header.sticky');
            if (header) {
                header.classList.remove('slim-header');
            }
            
            const footer = document.querySelector('footer');
            if (footer) {
                footer.classList.remove('slim-footer');
            }
            
            // Kembalikan padding container
            const container = document.querySelector('.container.mx-auto.px-4.py-4');
            if (container) {
                container.classList.remove('py-4');
                container.classList.add('py-8');
            }
        }
        
        // Fullscreen management
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const lockOverlay = document.getElementById('lockOverlay');
        const lockMessage = document.getElementById('lockMessage');
        let isLocked = false;
        
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        
        // Alt+L untuk toggle lock screen
        document.addEventListener('keydown', function(e) {
            if (e.altKey && e.key === 'l') {
                toggleScreenLock();
            }
        });
        
        function toggleScreenLock() {
            isLocked = !isLocked;
            
            if (isLocked) {
                lockOverlay.style.display = 'block';
                lockMessage.style.display = 'block';
                // Mencegah mouse events saat terkunci
                lockOverlay.style.pointerEvents = 'auto';
                // Tampilkan pesan selama 3 detik
                setTimeout(() => {
                    lockMessage.style.display = 'none';
                }, 3000);
            } else {
                lockOverlay.style.display = 'none';
                lockMessage.style.display = 'none';
                lockOverlay.style.pointerEvents = 'none';
            }
        }
        
        // Auto fullscreen saat halaman dimuat
        window.addEventListener('load', function() {
            setTimeout(function() {
                enterFullScreen();
                // Auto-lock setelah masuk fullscreen
                setTimeout(() => {
                    toggleScreenLock();
                }, 500);
            }, 1000);
        });
        
        function toggleFullScreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                enterFullScreen();
            } else {
                exitFullScreen();
            }
            
            updateFullscreenButton();
        }
        
        function enterFullScreen() {
            try {
                const elem = document.getElementById('kioskContainer');
                
                if (elem.requestFullscreen) {
                    elem.requestFullscreen({ navigationUI: "hide" });
                } else if (elem.mozRequestFullScreen) { // Firefox
                    elem.mozRequestFullScreen({ navigationUI: "hide" });
                } else if (elem.webkitRequestFullscreen) { // Chrome, Safari, Opera
                    elem.webkitRequestFullscreen({ navigationUI: "hide" });
                } else if (elem.msRequestFullscreen) { // IE/Edge
                    elem.msRequestFullscreen({ navigationUI: "hide" });
                }
            } catch (err) {
                console.error("Fullscreen error:", err);
            }
        }
        
        function exitFullScreen() {
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            } catch (err) {
                console.error("Exit fullscreen error:", err);
            }
        }
        
        function updateFullscreenButton() {
            if (document.fullscreenElement || 
                document.mozFullScreenElement || 
                document.webkitFullscreenElement || 
                document.msFullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = "Keluar dari Mode Layar Penuh";
            } else {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = "Mode Layar Penuh";
            }
        }
        
        // Mendeteksi perubahan mode fullscreen
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);
        
        // Jangan mencoba ulang fullscreen secara agresif
        // karena ini bisa menyebabkan browser menolak permintaan
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                console.log("Keluar dari mode fullscreen");
            }
        });
        
        // Reset posisi scroll ke atas saat refresh
        window.addEventListener('beforeunload', function() {
            window.scrollTo(0, 0);
        });
        
        // Deteksi perubahan jumlah poli (misalnya saat refresh data)
        // dan panggil handleResize untuk menyesuaikan
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    handleResize();
                }
            });
        });
        
        // Amati perubahan pada container poli
        const container = document.querySelector('.container.mx-auto.px-4.py-8');
        if (container) {
            observer.observe(container, { childList: true, subtree: true });
        }
        
        // Panggil resize handler saat ukuran jendela berubah
        window.addEventListener('resize', handleResize);
        
        // Panggil handleResize saat halaman dimuat dan ulangi beberapa kali
        // untuk memastikan layout benar-benar menyesuaikan
        handleResize();
        setTimeout(handleResize, 500);
        setTimeout(handleResize, 1000);
    </script>
</body>
</html>